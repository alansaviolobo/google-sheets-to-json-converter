name: Refresh Data
on:
  schedule:
    - cron: '0 * * * *'   # Run every hour
  workflow_dispatch:      # Allow manual trigger
  repository_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest
    permissions:
      contents: write     # Need write permission to update the cached file

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          ref: main

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Fetch and process API data
        run: npm start

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: Checkout the data branch to save the data.
        run: |
          echo "Backing up data..."
          mkdir -p ../data_backup
          mv data/* ../data_backup/
          
          echo "Switching to the data branch..."
          git checkout -b data
          git branch --set-upstream-to origin/data
          git pull
          
          echo "Restoring data..."
          # Ensure destination exists
          mkdir -p data
          # Remove old data to ensure we have a clean state relative to the generation
          rm -rf data/*
          cp ../data_backup/* data/

      - name: Commit and push changes
        run: |
          if git status -s | grep -q "data/"; then
            git add data/.
            git commit -m "Refresh GoogleSheets data"
            git push --set-upstream origin data
          else
            echo "No changes detected in data files"
          fi