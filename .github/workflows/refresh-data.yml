name: Refresh Data
on:
  schedule:
    - cron: '0 * * * *'   # Run every hour
  workflow_dispatch:      # Allow manual trigger

jobs:
  update-data:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          path: main-branch

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: main-branch/package-lock.json

      - name: Install dependencies and generate data
        working-directory: main-branch
        run: |
          npm install
          npm start

      - name: Checkout data branch
        uses: actions/checkout@v4
        with:
          ref: data
          path: data-branch

      - name: Copy generated data to data branch
        run: |
          # Ensure the source directory exists
          if [ -d "main-branch/data" ]; then
            echo "Data directory found. Copying files..."
            cp -r main-branch/data/* data-branch/
          else
            echo "Error: Data directory not found!"
            exit 1
          fi

      - name: Commit and push changes
        working-directory: data-branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check for changes
          if [[ -n $(git status -s) ]]; then
            git add .
            git commit -m "Refresh GoogleSheets data"
            git push
          else
            echo "No changes detected."
          fi